#!/usr/bin/env python3 
import os,sys,subprocess
import datetime
import creplot

sys.stdout = os.fdopen(sys.stdout.fileno(), 'w', buffering=1)
sys.stderr = os.fdopen(sys.stderr.fileno(), 'w', buffering=1)
sys.stdin = os.fdopen(sys.stdin.fileno(), 'r', buffering=1)
apikey = "FRaVT8iIl5JXLimgwLg"

args = sys.argv
if len(args) <2 or args[1] == "--help":
    print("Compute Crystal structures in MaterialProjects")
    print("Usage: ./job_mp ncore [mplistfile] [list of mpid] ")
    print("      For example, >./job_mp 32 list.job_mp ")
    print("      For example, >./job_mp 32 168 192 33  ")
    print("      Set your API key at https://materialsproject.org/open in job_mp")
    print("      log.job_mp contains minimum log")
    print("")
    sys.exit()
ncore   =args[1] 
listname=args[2]

try: #open listname if it is a file
    with open(listname) as f:
        joblist=[]
        datax=f.read()
        ddd=datax.split('\n')
        for m,i in enumerate(ddd):
            joblist.append(i.split(' ')[0])
            #print(joblist)
except:
    joblist=[]

print('job_mp core=',ncore)
print('')
fout=open('log.'+listname,'w')
for i in joblist+args[2:]:
    try:
       xxx=int(i)
    except:
       continue
    if(len(i)==0): continue
    starttime = datetime.datetime.now()
    outc=creplot.createplot(i,apikey,ncore)
    if(len(outc)==0): continue
    endtime = datetime.datetime.now()
    diff1=(endtime-starttime)
    difft=diff1.seconds
    print('mp-id=',i,"start@",starttime.strftime('%x %X'),":",difft," sec",outc.decode('utf-8'))
    print('mp-id=',i,"start@",starttime.strftime('%x %X'),":",difft," sec",outc.decode('utf-8'),file=fout,end='',flush=True)
