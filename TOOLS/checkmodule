#!/usr/bin/env python3
# This routine checks module-dependency in fortran90 and compile them in right order.
#
import os
import sys,subprocess
import re

def connect(alist):
        result=''
        for lll in alist:
                result = result + ' ' + lll
        return result

tmp ='chekckmodule.tmp'
src  = connect(sys.argv[1:])
print('TOOLS/checkmodule ==>  We are going to check module dependency file moduledepends.ing ... ')
zzz='grep -i --regexp="^\ *[Mm][Oo][Dd][Uu][Ll][Ee]" ' + src + ' >' + tmp
subprocess.call(zzz,shell=True)
oxx = open(tmp,'rt').read()
oxx = oxx.split('\n')
Rule={}
for ilinex in oxx:
        if len(ilinex)==0 : continue
        iline = ilinex.replace(':',': ') #fix for F90
        #print(iline)
        #print(iline.split())
        modulef = iline.split()[0].replace(':','')
        #print(modulef)
        if iline.split()[2].lower()=="procedure": continue
        #print( ' === Module', iline.split()[2],' is defined in ', modulef)
        zzz= 'grep -i ' + iline.split()[2] + ' ' + src +'|grep -E -i ":\s*(use)"'
        #print('|grep -E -i "^\s.*use"')
        os.system( zzz +' > ' + tmp)
        oww = open(tmp,'rt').read().split('\n')
        #print(oww)
        for ilinex in oww:        
                if(len(ilinex)==0): continue
                usef = ilinex.replace(':',' ').split()[0]
                if(  (modulef in Rule) == False and modulef != usef):
                        aaa=[]
                        Rule[modulef]= aaa + [usef]
                elif(modulef != usef):
                        aaa = Rule[modulef]
                        Rule[modulef]= aaa + [usef]
#print()
#print(' ------- We are going to obtaine make rules ... -------- ')
aaa='#This is generated by TOOLS/checkmodule'
for prereq0 in Rule.keys():
        for target0 in Rule[prereq0]:
                #print(prereq0,' x ',target0)
                prereq = re.sub('.F$','.o', prereq0)
                target = re.sub('.F$','.o', target0)
                prereq = re.sub('.F90$','.o', prereq)
                target = re.sub('.F90$','.o', target)
                #print(target +': '+prereq)
                aaa=aaa + target +': '+prereq+'\n'
oxx = open("moduledepends.inc",'wt')
oxx.write(aaa)
sys.exit()
