      subroutine dsolv2(a11,a12,a21,a22,n,kpvt,wk,v,nvec)

C- Solves simultaneous eqns from routine decmp2
C ----------------------------------------------------------------
Ci Inputs
Ci   a11,a12,a21,a22
Ci   n:    dimension of (square) matrices a11, a22;
Ci         a12 and a21 are vectors of length n
Ci   v:    vector for which A X = v
Ci   nvec: number of vectors v for which to solve eqns.
Ci   kpvt: integer work array of length n
Ci   wk:   work array of length 2*n*nvec
Co Outputs
Co   v is replaced by A^-1 v
Cr Remarks
Cr   Matrices a11,a22,kvpt are generated by decmp2
Cu Updates
Cu   06 Aug 06 Redesigned to work with lapack
C ----------------------------------------------------------------
C     implicit none
C Passed parameters
      integer n,nvec,kpvt(n)
      double precision a11,a12,a21,a22,v,wk
      dimension a11(1),a12(1),a21(1),a22(1),
     .          v(2*n,nvec),wk(n,2*nvec)
C Local parameters
      integer i,j,ndef

      call tcn('dsolv2')

C --- Scale v1 by a11^-1 ---
      call dmcpy(v,n+n,1,wk,n,1,n,nvec)
C ... Packed version
C     call dpack(a11,n)
C     call dpmpy(a11,wk,n,1,v,n+n,1,n,nvec,n)
C ... Normal version
      call dgemm('N','N',n,nvec,n,1d0,a11,n,wk,n,0d0,v,2*n)
C     call prmx('a11^-1 v1',v,2*n,n,nvec)

C --- Make v2 - a21 a11^-1 v1 ---
      do  20  i = 1, n
      do  20  j = 1, nvec
   20 v(n+i,j) = v(n+i,j) - a21(i)*v(i,j)

C --- Solve (a22 - a21 a11^-1 a12) x2 = v2 - a21 a11^-1 v1 ---
C ... Packed Linpack version
C     do  40  j = 1, nvec
C  40 call dspsl(a22,n,kpvt,v(n+1,j))
C ... Linpack version
C      do  40  j = 1, nvec
C   40 call dsisl(a22,n,n,kpvt,v(n+1,j))
C ... Lapack version
      call dsytrs('U',n,nvec,a22,n,kpvt,v(n+1,1),2*n,ndef)
      if (ndef .ne. 0) call rx('decmp2: matrix a22 singular')

C --- Subtract a11^-1 a12 x2 from v1 to make x1---
      do  50  i = 1, n
      do  50  j = 1, nvec
   50 wk(i,j) = -a12(i) * v(n+i,j)
C     call dpack(a11,n)
C     call dpmpy(a11,wk,n,1,wk(1,1+nvec),n,1,n,nvec,n)
      call dgemm('N','N',n,nvec,n,1d0,a11,n,wk,n,0d0,wk(1,1+nvec),n)
      call dmadd(v,n+n,1,1d0,wk(1,1+nvec),n,1,1d0,v,n+n,1,n,nvec)

      call tcx('dsolv2')
Cgetarg       end
       end subroutine dsolv2 


