#!/usr/bin/env python3
# checkmodule.py This routine checks module-dependency in fortran90 and compile them in right order.
# Usage:
#> chackmodule.py [source files] 
#
#In makefile, write lines as follows
#--------------------------------
#moduledepends.inc: $(subr)*.f90 $(main)*.f90 $(maxloc)*.f90
#	@echo 'init: Generate module-dependency file, moduledepends.$(PLATFORM).inc'
#	@[ -d moduledepends.inc ] || exec ../../TOOLS/checkmodule $(subr)*.f90 $(main)*.f90 $(maxloc)*.f90 
#--------------------------------
# This lines generetes *.f90 dependency file "moduledepends.inc" is generated from $(subr)*.f90 $(main)*.f90 $(maxloc)*.f90.
#

import os
import sys,subprocess
import re
def connect(alist):
        result=''
        for lll in alist:
                result = result + ' ' + lll
        return result
tmp ='chekckmodule.tmp'
src  = connect(sys.argv[1:])
print('TOOLS/checkmodule ==>  We are going to check module dependency file moduledepends.ing ... ')
zzz='grep -i --regexp="^\ *[Mm][Oo][Dd][Uu][Ll][Ee]" ' + src + ' >' + tmp
subprocess.call(zzz,shell=True)
oxx = open(tmp,'rt').read()
oxx = oxx.split('\n')
Rule={}
for ilinex in oxx:
        if len(ilinex)==0 : continue
        iline = ilinex.replace(':',': ') #fix for F90
        modulef = iline.split()[0].replace(':','')
        if iline.split()[2].lower()=="procedure": continue
        zzz= 'grep -i ' + iline.split()[2] + ' ' + src +'|grep -E -i ":\s*(use)"'
        os.system( zzz +' > ' + tmp)
        oww = open(tmp,'rt').read().split('\n')
        for ilinex in oww:        
                if(len(ilinex)==0): continue
                usef = ilinex.replace(':',' ').split()[0]
                if(  (modulef in Rule) == False and modulef != usef):
                        aaa=[]
                        Rule[modulef]= aaa + [usef]
                elif(modulef != usef):
                        aaa = Rule[modulef]
                        Rule[modulef]= aaa + [usef]
aaa='#This is generated by TOOLS/checkmodule'
for prereq0 in Rule.keys():
        for target0 in Rule[prereq0]:
                prereq = re.sub('.F$','.o', prereq0)
                target = re.sub('.F$','.o', target0)
                prereq = re.sub('.f90$','.o', prereq)
                target = re.sub('.f90$','.o', target)
                aaa=aaa + target +': '+prereq+'\n'
oxx = open("moduledepends.inc",'wt')
oxx.write(aaa)
sys.exit()
